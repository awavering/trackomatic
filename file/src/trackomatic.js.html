<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/trackomatic.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/vigetlabs/trackomatic.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugin.js~Plugin.html">Plugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/trackomatic.js~Trackomatic.html">Trackomatic</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-once">once</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-providePlugin">providePlugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-config">config</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-plugin">plugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-trackomatic">trackomatic</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-util">util</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">plugins</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/errorReportingPlugin.js~ErrorReportingPlugin.html">ErrorReportingPlugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/firstInputPlugin.js~FirstInputPlugin.html">FirstInputPlugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/linkTrackingPlugin.js~LinkTrackingPlugin.html">LinkTrackingPlugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/viewportTrackingPlugin.js~ViewportTrackingPlugin.html">ViewportTrackingPlugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-errorReportingPlugin">errorReportingPlugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-firstInputPlugin">firstInputPlugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-linkTrackingPlugin">linkTrackingPlugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-viewportTrackingPlugin">viewportTrackingPlugin</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/trackomatic.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const ready   = require(&apos;domready&apos;)
const plugins = require(&apos;./plugins&apos;)
const config  = require(&apos;./config&apos;)
const util    = require(&apos;./util&apos;)

const defaultTrackParams = require(&apos;./trackParams&apos;)

/**
 * When called with `new`, creates a new instance of the Trackomatic analytics class
 */
class Trackomatic {
  /**
   * Trackomatic class constructor
   *
   * @param  { Object } tracker - Tracker passed in by Google Analytics
   * @param  { Object } options - Trackomatic configuration object
   * @return { Void }
   **/
  constructor(tracker, options={}) {
    window._trackomatic = window._trackomatic || this

    this.util    = util
    this.config  = config
    this.tracker = tracker
    this.options = this.prepare({ ...config.DEFAULTS, ...options })

    ready(this.boot.bind(this))
  }

  /**
   * Prepares the Trackomatic options by converting `options.networks`
   * and `options.files` from Strings or Array&lt;String&gt; into RegExp
   *
   * @param  { Object } options - Trackomatic&apos;s options object
   * @return { Object }         - The prepared options object
   **/
  prepare(options) {
    return {
      ...options,
      networks : util.regexify(options.networks),
      files    : util.regexify(options.files)
    }
  }

  /**
   * Loads all of Trackomatic&apos;s plugins
   *
   * @return { Void }
   **/
  boot() {
    if (__DEV__ &amp;&amp; this.options.debug) {
      console.log(
        &apos;Loaded trackomatic on tracker &apos; + this.tracker.get(&apos;name&apos;) +
        &apos; with the config object &apos; + JSON.stringify(this.options)
      )

      // window.dataLayer is provided by GTM
      if (typeof dataLayer === typeof undefined) {
        console.warn(
          &apos;Warning: Trackomatic could not find the global \
          &quot;dataLayer&quot; object from GTM. Did you load GTM first?&apos;
        )
      }
    }

    for (let key in plugins) {
      new plugins[key](this)
    }
  }

  /**
   * Sends track parameters to the configured Google Analytics account via
   * the tracker that was passed to the Trackomatic constructor
   *
   * @param  { Object } params - Object of keys and values to send to GA/GTM
   * @return { Void }
   **/
  track(params) {
    params = this.prefix({ ...defaultTrackParams, ...params })

    this.notifyGA(params)
    this.notifyGTM(params)
  }

  /**
   * When given a trackomatic tracking object, this function will add the
   * configured prefix to the `category` property
   *
   * @param  { Object } params - Tracking object to be prefixed
   * @return { Object }        - The tracking object with prefixed properties
   **/
  prefix({ category, ...params }) {
    const { prefix } = this.options
    return { ...params, category: `${ prefix } - ${ category }` }
  }

  /**
   * Provided `window.dataLayer` exists, `notifyGTM` will push values to it
   *
   * @param  { Object } params - Object of keys and values to send to GTM
   * @return { Void }
   **/
  notifyGTM(params) {
    // extract params that shouldn&apos;t be sent to GTM
    const { nonInteraction, hitType, hitCallback, ...GTMParams } = params
    const GTMLoaded = (typeof dataLayer !== typeof undefined)

    if (__DEV__ &amp;&amp; this.options.debug) {
      console.log(&apos;dataLayer.push(..): &apos;)
      console.log(JSON.stringify(GTMParams, null, &apos;  &apos;))
      return
    }

    GTMLoaded &amp;&amp; dataLayer.push(GTMParams)
  }

  /**
   * Sends track parameters to the configured Google Analytics account via
   * the tracker that was passed to the Trackomatic constructor
   *
   * @param  { Object } params - Object of keys and values to send to GTM
   * @return { Void }
   **/
  notifyGA(params) {
    let GAParams = [
      params.hitType,
      params.category,
      params.action,
      params.label,
      params.value,
      {
        nonInteraction : params.nonInteraction,
        hitCallback    : params.hitCallback
      }
    ]

    if (__DEV__ &amp;&amp; this.options.debug) {
      console.log(&apos;tracker.send(..): &apos;)
      console.log(JSON.stringify(GAParams, null, &apos;  &apos;))
      return
    }

    this.tracker.send(...GAParams)
  }
}

export default Trackomatic
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.3.1)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
